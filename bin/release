#!/usr/bin/env ruby
require "bundler/inline"
gemfile(true, quiet: true) do
  source "https://rubygems.org"
  gem "github_api"
end

require "github_api"
require "pathname"
require "json"

class Release
  NAME = "Trix"
  REPO = "trix"
  OWNER = "basecamp"

  def perform
    confirm_version
    check_github_release
    check_npm

    build
    push_git_tag
    create_release
    npm_publish
  end

  def version
    @version ||= JSON.load_file("package.json")["version"]
  end

  def confirm_version
    confirm("Release #{NAME} #{version}?") || abort
  end

  def build
    puts "Building…"
    system("yarn install && yarn build") || abort("Build failed")
  end

  def push_git_tag
    system("git tag #{version}") && system("git push --tags")
  end

  def create_release
    puts "Creating release…"
    release = github.repos.releases.create(OWNER, REPO, tag_name: version)

    puts "Uploading dist files for release…"
    dist_pathnames.each do |pathname|
      github.repos.releases.assets.upload OWNER, REPO, release.id, pathname.to_s, name: pathname.basename.to_s, content_type: content_type(pathname)
    end
  end

  def dist_pathnames
    Pathname.new("dist").children
  end

  def content_type(pathname)
    case pathname.extname
    when ".js"  then "application/javascript"
    when ".css" then "text/css"
    end
  end

  def check_github_release
    releases = github.repos.releases.list(OWNER, REPO)
    if release = releases.detect { |release| release.tag_name == version }
      abort "Already released #{version}: #{release.html_url}"
    end
  end

  def github
    @github ||= Github.new(oauth_token: ENV.fetch("GITHUB_TOKEN"))
  end

  def check_npm
    system("npm whoami") || abort("Must be logged in to npm" )
  end

  def npm_publish
    puts "Publishing to npm…"
    system("npm publish") || abort("npm publish failed")
  end

  def confirm(question)
    print "#{question} (y/n) "
    gets.chomp.downcase == "y"
  end
end

Release.new.perform
